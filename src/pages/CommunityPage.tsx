import { motion, AnimatePresence } from "framer-motion";
import { useState, useEffect, useRef } from "react";
import ParchmentPanel from "@/components/ParchmentPanel";
import { Skeleton } from "@/components/ui/skeleton";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { useAuth } from "@/contexts/AuthContext";
import {
  fetchCommunityFeed,
  createCommunityPost,
  updateCommunityPost,
  deleteCommunityPost,
} from "@/lib/api";
import type { CommunityPost } from "@/lib/types";
import { toast } from "sonner";
import { 
  Edit2, 
  Trash2, 
  PlusCircle, 
  Search, 
  X, 
  Heart, 
  MessageCircle, 
  Share2, 
  MoreHorizontal,
  TrendingUp,
  Award,
  Users
} from "lucide-react";

const CommunityPage = () => {
  const { token, user } = useAuth();
  const [posts, setPosts] = useState<CommunityPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [query, setQuery] = useState("");
  const [page, setPage] = useState(1);
  const pageSize = 20;
  const [totalCount, setTotalCount] = useState(0);
  const [loadingMore, setLoadingMore] = useState(false);
  const sentinelRef = useRef<HTMLDivElement | null>(null);

  // CRUD State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingPost, setEditingPost] = useState<CommunityPost | null>(null);
  const [formTitle, setFormTitle] = useState("");
  const [formBody, setFormBody] = useState("");
  const [formTags, setFormTags] = useState("");

  const fetchFeed = async (p: number, reset = false) => {
    try {
      if (reset) setLoading(true);
      else setLoadingMore(true);

      const feed = await fetchCommunityFeed(p, pageSize);
      setTotalCount(feed.totalCount);
      
      if (reset) {
        setPage(1);
        setPosts(feed.posts.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()));
      } else {
        setPage(p);
        setPosts((prev) => {
          const merged = [...prev, ...feed.posts];
          const unique = Array.from(new Map(merged.map((p) => [p.id, p])).values());
          return unique.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
        });
      }
    } catch (error) {
      toast.error("í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setLoading(false);
      setLoadingMore(false);
    }
  };

  useEffect(() => {
    if (!token) return;
    fetchFeed(1, true);
  }, [token]);

  const handleOpenCreate = () => {
    setEditingPost(null);
    setFormTitle("");
    setFormBody("");
    setFormTags("");
    setIsModalOpen(true);
  };

  const handleOpenEdit = (e: React.MouseEvent, post: CommunityPost) => {
    e.stopPropagation();
    setEditingPost(post);
    setFormTitle(post.title);
    setFormBody(post.body);
    setFormTags(post.tags.join(", "));
    setIsModalOpen(true);
  };

  const handleDelete = async (e: React.MouseEvent, postId: string) => {
    e.stopPropagation();
    if (!confirm("ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
      await deleteCommunityPost(postId);
      setPosts((prev) => prev.filter((p) => p.id !== postId));
      toast.success("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
      toast.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  const handleSubmit = async () => {
    if (!formTitle.trim() || !formBody.trim()) {
      toast.error("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const tags = formTags
      .split(",")
      .map((t) => t.trim())
      .filter((t) => t !== "");

    try {
      if (editingPost) {
        const updated = await updateCommunityPost({
          postId: editingPost.id,
          title: formTitle,
          body: formBody,
          tags,
        });
        setPosts((prev) => prev.map((p) => (p.id === updated.id ? updated : p)));
        toast.success("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        if (!user) return;
        const created = await createCommunityPost({
          userId: user.id,
          authorNickname: user.nickname || "ìµëª… íƒì •",
          authorEmoji: user.avatarEmoji || "ğŸ•µï¸",
          title: formTitle,
          body: formBody,
          tags,
        });
        setPosts((prev) => [created, ...prev]);
        toast.success("ìƒˆ ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      setIsModalOpen(false);
    } catch (error) {
      toast.error("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  const normalizedQuery = query.trim().toLowerCase();
  const visiblePosts = normalizedQuery
    ? posts.filter((p) => {
        const hay = `${p.title} ${p.body} ${p.tags.join(" ")}`.toLowerCase();
        return hay.includes(normalizedQuery);
      })
    : posts;

  useEffect(() => {
    if (!token) return;
    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0];
        const canLoadMore = posts.length < totalCount;
        if (entry.isIntersecting && !loading && !loadingMore && canLoadMore) {
          fetchFeed(page + 1);
        }
      },
      { threshold: 0.1 }
    );
    const el = sentinelRef.current;
    if (el) observer.observe(el);
    return () => {
      if (el) observer.unobserve(el);
      observer.disconnect();
    };
  }, [token, loading, loadingMore, posts.length, totalCount, page]);

  return (
    <motion.div
      className="min-h-screen flex flex-col gap-6 p-6 max-w-[1200px] mx-auto overflow-x-hidden"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      {/* Header Section */}
      <header className="flex flex-col gap-4">
        <div className="flex justify-between items-end">
          <div className="flex flex-col gap-1">
            <h1 className="font-jua text-5xl text-foreground text-shadow-glow tracking-tight">ğŸ“œ ë™ë¬¼ë“¤ì˜ ê´‘ì¥</h1>
            <p className="text-muted-foreground font-jua text-lg opacity-80">íƒì •ë“¤ì˜ ë¹„ë°€ ì •ë³´ì™€ ì¼ìƒì´ ê³µìœ ë˜ëŠ” ê³³</p>
          </div>
          <Button
            onClick={handleOpenCreate}
            size="lg"
            className="font-jua text-xl bg-orange-500 hover:bg-orange-600 text-white gap-3 shadow-lg hover:shadow-orange-500/20 transform hover:-translate-y-1 transition-all rounded-2xl px-8"
          >
            <PlusCircle size={24} />
            ìƒˆ ì •ë³´ ì œë³´í•˜ê¸°
          </Button>
        </div>

        <div className="relative group">
          <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground group-focus-within:text-orange-500 transition-colors" size={22} />
          <Input
            placeholder="ì–´ë–¤ ì •ë³´ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”? (ì œëª©, ë‚´ìš©, íƒœê·¸...)"
            className="pl-12 py-7 text-xl rounded-2xl border-2 border-parchment-border bg-white/50 backdrop-blur-sm focus-visible:ring-orange-500/50 font-jua"
            value={query}
            onChange={(e) => setQuery(e.target.value)}
          />
          {query && (
            <button
              onClick={() => setQuery("")}
              className="absolute right-4 top-1/2 -translate-y-1/2 p-1 hover:bg-black/5 rounded-full transition-colors"
            >
              <X size={20} />
            </button>
          )}
        </div>
      </header>

      {/* Main Content Layout */}
      <div className="flex gap-8 relative">
        {/* Left: Feed */}
        <div className="flex-1 flex flex-col gap-6">
          {loading ? (
            <div className="flex flex-col gap-6">
              {[1, 2, 3].map((i) => (
                <ParchmentPanel key={i} className="p-8 rounded-[2rem]">
                  <div className="flex gap-4 mb-4">
                    <Skeleton className="h-14 w-14 rounded-full bg-parchment-border/50" />
                    <div className="flex-1 space-y-2">
                      <Skeleton className="h-6 w-1/4 bg-parchment-border/50" />
                      <Skeleton className="h-4 w-1/6 bg-parchment-border/50" />
                    </div>
                  </div>
                  <Skeleton className="h-8 w-3/4 rounded bg-parchment-border/50 mb-4" />
                  <Skeleton className="h-24 w-full rounded bg-parchment-border/50" />
                </ParchmentPanel>
              ))}
            </div>
          ) : (
            <AnimatePresence mode="popLayout">
              <div className="flex flex-col gap-6">
                {visiblePosts.length === 0 ? (
                  <motion.div 
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="py-32 text-center"
                  >
                    <div className="text-8xl mb-6">ğŸ•µï¸â€â™‚ï¸ğŸ”</div>
                    <div className="opacity-50 font-jua text-3xl text-wood-dark">
                      ì•„ë¬´ëŸ° í”ì ë„ ì°¾ì§€ ëª»í–ˆì–´ìš”...
                    </div>
                    <p className="text-muted-foreground font-jua mt-2">ìƒˆë¡œìš´ ì •ë³´ë¥¼ ì œë³´í•´ ì£¼ì‹œê² ì–´ìš”?</p>
                  </motion.div>
                ) : (
                  visiblePosts.map((post) => (
                    <motion.div 
                      key={post.id} 
                      layout
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, scale: 0.95 }}
                      whileHover={{ y: -4 }}
                      className="w-full"
                    >
                      <ParchmentPanel className="p-0 overflow-hidden rounded-[2rem] border-[6px] group transition-all duration-300 hover:shadow-2xl">
                        <div className="p-8">
                          {/* Post Header */}
                          <div className="flex items-start justify-between mb-5">
                            <div className="flex items-center gap-4">
                              <div className="w-14 h-14 rounded-full bg-white/50 border-2 border-parchment-border flex items-center justify-center text-4xl shadow-inner">
                                {post.authorEmoji}
                              </div>
                              <div className="flex flex-col">
                                <span className="font-jua text-2xl tracking-tight text-wood-darkest">
                                  {post.authorNickname}
                                </span>
                                <span className="text-sm opacity-60 font-medium">
                                  {new Date(post.createdAt).toLocaleDateString("ko-KR", { 
                                    month: 'long', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                  })}
                                </span>
                              </div>
                            </div>
                            
                            <div className="flex gap-1">
                              {user && (post.userId === user.id || post.authorNickname === user.nickname) && (
                                <>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-10 w-10 rounded-full text-blue-600 hover:bg-blue-50/50"
                                    onClick={(e) => handleOpenEdit(e, post)}
                                  >
                                    <Edit2 size={18} />
                                  </Button>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-10 w-10 rounded-full text-red-600 hover:bg-red-50/50"
                                    onClick={(e) => handleDelete(e, post.id)}
                                  >
                                    <Trash2 size={18} />
                                  </Button>
                                </>
                              )}
                              <Button variant="ghost" size="icon" className="h-10 w-10 rounded-full opacity-40">
                                <MoreHorizontal size={20} />
                              </Button>
                            </div>
                          </div>

                          {/* Post Content */}
                          <div className="space-y-4 mb-6">
                            <h3 className="font-jua text-3xl leading-tight text-wood-darkest group-hover:text-orange-600 transition-colors">
                              {post.title}
                            </h3>
                            <p className="text-lg leading-relaxed text-wood-dark whitespace-pre-wrap line-clamp-4 font-medium">
                              {post.body}
                            </p>
                          </div>

                          {/* Tags */}
                          <div className="flex flex-wrap gap-2 mb-6">
                            {post.tags.map((t) => (
                              <Badge 
                                key={t} 
                                variant="secondary" 
                                className="bg-white/50 hover:bg-orange-100 text-orange-700 border-none px-4 py-1.5 text-sm font-jua rounded-xl transition-colors cursor-pointer"
                              >
                                #{t}
                              </Badge>
                            ))}
                          </div>

                          {/* Post Footer: Actions */}
                          <div className="flex items-center justify-between pt-6 border-t border-black/5">
                            <div className="flex gap-2">
                              <Button variant="ghost" className="gap-2 font-jua text-lg hover:bg-red-50 hover:text-red-500 rounded-xl px-4 group/btn">
                                <Heart size={20} className="group-hover/btn:fill-current" />
                                <span>{post.likes}</span>
                              </Button>
                              <Button variant="ghost" className="gap-2 font-jua text-lg hover:bg-blue-50 hover:text-blue-500 rounded-xl px-4">
                                <MessageCircle size={20} />
                                <span>{post.comments}</span>
                              </Button>
                            </div>
                            <Button variant="ghost" className="gap-2 font-jua text-lg hover:bg-orange-50 hover:text-orange-500 rounded-xl px-4">
                              <Share2 size={20} />
                              <span>ê³µìœ </span>
                            </Button>
                          </div>
                        </div>
                      </ParchmentPanel>
                    </motion.div>
                  ))
                )}
              </div>
            </AnimatePresence>
          )}
          
          <div ref={sentinelRef} className="h-10 w-full" />
          {loadingMore && (
            <div className="flex justify-center py-10">
              <motion.div 
                animate={{ rotate: 360 }}
                transition={{ repeat: Infinity, duration: 1, ease: "linear" }}
                className="text-4xl"
              >
                ğŸ¦‰
              </motion.div>
            </div>
          )}
        </div>

        {/* Right: Sidebar */}
        <aside className="hidden lg:flex flex-col gap-6 w-[340px] sticky top-6 h-fit">
          <ParchmentPanel className="p-6 rounded-3xl border-4">
            <h4 className="font-jua text-2xl mb-4 flex items-center gap-2">
              <TrendingUp className="text-orange-500" size={24} />
              ì¸ê¸° íƒì • ì œë³´
            </h4>
            <div className="flex flex-col gap-4">
              {[
                { title: "ë”¥í˜ì´í¬ íƒì§€ê¸° 100% í™œìš©ë²•", likes: 1240, comments: 82 },
                { title: "ìµœê·¼ ìœ í–‰í•˜ëŠ” AI ì‚¬ê¸° ìœ í˜•", likes: 856, comments: 45 },
                { title: "íƒì • ë“±ê¸‰ ë¹¨ë¦¬ ì˜¬ë¦¬ëŠ” íŒ", likes: 620, comments: 31 },
              ].map((item, idx) => (
                <div key={idx} className="group cursor-pointer">
                  <p className="font-jua text-lg group-hover:text-orange-600 transition-colors truncate">{item.title}</p>
                  <div className="flex gap-3 text-sm opacity-50 font-bold mt-1">
                    <span>ğŸ”¥ {item.likes}</span>
                    <span>ğŸ’¬ {item.comments}</span>
                  </div>
                </div>
              ))}
            </div>
          </ParchmentPanel>

          <ParchmentPanel className="p-6 rounded-3xl border-4 bg-orange-50/30">
            <h4 className="font-jua text-2xl mb-4 flex items-center gap-2">
              <Award className="text-yellow-600" size={24} />
              ì´ë‹¬ì˜ ëª…íƒì •
            </h4>
            <div className="flex flex-col gap-3">
              {[
                { name: "ìˆ˜ë¦¬ ë¶€ì—‰ì´", emoji: "ğŸ¦‰", rank: "Master" },
                { name: "ì˜ë¦¬í•œ ì—¬ìš°", emoji: "ğŸ¦Š", rank: "Pro" },
                { name: "ë°œ ë¹ ë¥¸ ì¹˜íƒ€", emoji: "ğŸ†", rank: "Expert" },
              ].map((detective, idx) => (
                <div key={idx} className="flex items-center gap-3">
                  <span className="text-3xl">{detective.emoji}</span>
                  <div className="flex flex-col">
                    <span className="font-jua text-lg">{detective.name}</span>
                    <span className="text-xs font-bold text-orange-600 uppercase tracking-wider">{detective.rank}</span>
                  </div>
                </div>
              ))}
            </div>
          </ParchmentPanel>

          <ParchmentPanel className="p-6 rounded-3xl border-4">
            <div className="flex items-center gap-3 mb-4">
              <Users className="text-blue-500" size={24} />
              <h4 className="font-jua text-2xl">ê´‘ì¥ í†µê³„</h4>
            </div>
            <div className="grid grid-cols-2 gap-4 text-center">
              <div className="bg-white/40 p-3 rounded-2xl border-2 border-parchment-border">
                <div className="text-2xl font-jua">1,240</div>
                <div className="text-xs opacity-60 font-bold">í™œë™ íƒì •</div>
              </div>
              <div className="bg-white/40 p-3 rounded-2xl border-2 border-parchment-border">
                <div className="text-2xl font-jua">8.5k</div>
                <div className="text-xs opacity-60 font-bold">ëˆ„ì  ì œë³´</div>
              </div>
            </div>
          </ParchmentPanel>

          <footer className="px-4 text-xs opacity-40 font-bold space-y-2">
            <div className="flex gap-3 underline">
              <button className="hover:text-foreground">ì‚¬ë¬´ì†Œ ì •ì±…</button>
              <button className="hover:text-foreground">ì´ìš© ê·œì¹™</button>
              <button className="hover:text-foreground">ë¬¸ì˜í•˜ê¸°</button>
            </div>
            <p>Â© 2026 PAWFILER Detective Agency. All Rights Reserved.</p>
          </footer>
        </aside>
      </div>

      {/* Write/Edit Modal */}
      <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
        <DialogContent className="bg-parchment border-parchment-border sm:max-w-[600px] rounded-[2.5rem] p-0 overflow-hidden border-[8px]">
          <div className="p-10">
            <DialogHeader className="mb-6">
              <DialogTitle className="font-jua text-4xl text-wood-darkest text-shadow-glow">
                {editingPost ? "ğŸ“œ ì •ë³´ ìˆ˜ì •í•˜ê¸°" : "ğŸ–‹ï¸ ìƒˆë¡œìš´ ì œë³´ ì ‘ìˆ˜"}
              </DialogTitle>
              <p className="text-muted-foreground font-jua text-lg mt-1">
                ë‹¤ë¥¸ íƒì •ë“¤ì—ê²Œ ë„ì›€ì´ ë  ë§Œí•œ ì •í™•í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
              </p>
            </DialogHeader>
            <div className="flex flex-col gap-6 py-4">
              <div className="flex flex-col gap-3">
                <label className="font-jua text-2xl text-wood-dark tracking-tight">ì •ë³´ ì œëª©</label>
                <Input
                  placeholder="ë¬´ì—‡ì— ê´€í•œ ì •ë³´ì¸ê°€ìš”? (ì˜ˆ: ë”¥í˜ì´í¬ íŒë³„ ê¿€íŒ)"
                  value={formTitle}
                  onChange={(e) => setFormTitle(e.target.value)}
                  className="py-6 text-xl rounded-2xl border-4 border-parchment-border focus-visible:ring-orange-500 font-jua bg-white/50"
                />
              </div>
              <div className="flex flex-col gap-3">
                <label className="font-jua text-2xl text-wood-dark tracking-tight">ìƒì„¸ ë‚´ìš©</label>
                <Textarea
                  placeholder="ë°œê²¬í•˜ì‹  ë‹¨ì„œë‚˜ íŒì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”. ë™ë£Œ íƒì •ë“¤ì´ ë¶„ì„í•  ìˆ˜ ìˆë„ë¡ìš”!"
                  value={formBody}
                  onChange={(e) => setFormBody(e.target.value)}
                  className="min-h-[200px] text-xl py-4 rounded-2xl border-4 border-parchment-border focus-visible:ring-orange-500 font-jua bg-white/50 leading-relaxed"
                />
              </div>
              <div className="flex flex-col gap-3">
                <label className="font-jua text-2xl text-wood-dark tracking-tight">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <Input
                  placeholder="ì˜ˆ: íŒ, ë¶„ì„ê²°ê³¼, ì£¼ì˜ì‚¬í•­"
                  value={formTags}
                  onChange={(e) => setFormTags(e.target.value)}
                  className="py-6 text-xl rounded-2xl border-4 border-parchment-border focus-visible:ring-orange-500 font-jua bg-white/50"
                />
              </div>
            </div>
            <DialogFooter className="mt-8 gap-4">
              <Button
                variant="ghost"
                onClick={() => setIsModalOpen(false)}
                className="font-jua text-xl h-14 px-8 rounded-2xl border-4 border-parchment-border hover:bg-black/5"
              >
                ë‚˜ì¤‘ì— í•˜ê¸°
              </Button>
              <Button
                onClick={handleSubmit}
                className="font-jua text-xl h-14 px-12 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl shadow-lg hover:shadow-orange-500/30 transform hover:-translate-y-1 transition-all"
              >
                {editingPost ? "ìˆ˜ì • ì™„ë£Œ" : "ì œë³´í•˜ê¸°"}
              </Button>
            </DialogFooter>
          </div>
        </DialogContent>
      </Dialog>
    </motion.div>
  );
};

export default CommunityPage;
